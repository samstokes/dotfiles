#!/bin/bash

timing_info=$(mktemp /tmp/monitor.XXXXXX)
trap "rm -f \"$timing_info\"" EXIT

notify() {
  title="$1"; shift
  what="$1"
  group="$(tty):$what"
  /Applications/terminal-notifier.app/Contents/MacOS/terminal-notifier \
      -title "$title" \
      -subtitle "$what" \
      -message "$*" \
      -group "$group" \
      -activate com.googlecode.iterm2
}

pending() {
  notify "Starting: $1" "$*"
}

success() {
  notify "SUCCEEDED: $1" "$*" "<$(head -c 256 "$timing_info")>"
  exit 0
}

failure() {
  code=$1
  shift
  notify "FAILED ($code): $1" "$*" "<$(head -c 256 "$timing_info")>"
  exit $code
}

pending $@
/usr/bin/time -p "$@" 2>"$timing_info" && success $@ || failure $? $@
